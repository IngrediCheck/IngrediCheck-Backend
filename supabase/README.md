# Supabase Development Workflow

This document outlines the workflow for managing database schema changes and migrations for the IngrediCheck Backend. We follow a **Declarative Schema** approach using the Supabase CLI.

## Core Concept

We treat the files in `supabase/schemas/` as the **source of truth** for our database structure.
- **`supabase/schemas/`**: Declarative SQL files defining the *desired state* of the database (Tables, Functions, RLS policies, etc.).
- **`supabase/migrations/`**: Versioned SQL files generated by the CLI to transition the database from one state to another. **These are what actually run in CI/CD.**

## Daily Workflow

### 1. Make Schema Changes
When building a feature or fixing a bug, modify the relevant files in `supabase/schemas/` or create new ones.

**Example:**
To add a function, edit `supabase/schemas/012_family_functions.sql` and update the SQL definition directly in that file.

### 2. Start Local Environment
Ensure your local Supabase instance is running:
```bash
supabase start
```

### 3. Generate Migration
Run the `db diff` command to generate a migration file based on your schema changes. This command compares your local migration history against the declarative state in `schemas/`.

```bash
supabase db diff --use-migra -f <descriptive_name>
# Example: supabase db diff --use-migra -f add_recipe_sharing
```

This creates a new file: `supabase/migrations/<timestamp>_<descriptive_name>.sql`.

### 4. Review & Apply Locally
1.  **Review the generated migration file.** Ensure it captures your intent correctly.
    *   *Note:* `migra` (the underlying tool) is powerful but not perfect. Check for missing RLS policies or data migrations.
2.  **Apply the migration locally** to verify it works and update your local DB:
    ```bash
    supabase migration up
    ```

### 5. Commit & Push
Commit both the schema changes (for documentation/source of truth) and the migration file (for deployment).

```bash
git add supabase/schemas/ supabase/migrations/
git commit -m "feat: add recipe sharing"
git push origin main
```

## CI/CD Deployment
We have GitHub Actions configured to handle testing and deployment automatically:

1.  **Regression Tests (`regression-tests.yml`):**
    - Runs on every push to `main` involving migrations, functions, or tests.
    - Spins up a fresh local Supabase.
    - Applies *all* migrations to verify integrity.
    - Runs the test suite.

2.  **Production Deploy (`deploy-edge-functions-prod.yml`):**
    - Runs **only** after Regression Tests pass.
    - Executes `supabase db push` against the production database.
    - Deploys updated Edge Functions.

## Troubleshooting
- **"Migration history mismatch"**: If CI fails saying remote has migrations not found locally, it usually means someone modified Prod directly or history got out of sync. Use `supabase migration repair` with extreme caution or sync with the team.
- **Order of Schemas**: The order in which schema files are loaded matters (e.g., tables before foreign keys). This is controlled in `supabase/config.toml` under `[db.migrations]`.

## Key Commands Reference
- `supabase start`: Start local dev environment.
- `supabase db diff --use-migra -f <name>`: Generate migration from schema changes.
- `supabase migration up`: Apply pending migrations to local DB.
- `supabase db reset`: Wipe local DB and re-apply all migrations from scratch.

